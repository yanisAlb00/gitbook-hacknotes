# Fonctionnement de la librairie Log4J et de la fonctionnalité JNDI

## à quoi sert Log4J ?

Log4J est une librairie utilisée par les développeurs Java pour journaliser certains évènements lors de l'exécution du code.

**Exemple de code en Java utilisant la librairie log4j pour journaliser des évènements :**&#x20;

```java
package fr.koor.samples.log4j2;

import org.apache.logging.log4j.Level;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class TestLog4J {

    // Récupération de notre logger.
    private static final Logger LOGGER =  LogManager.getLogger( TestLog4J.class );

    // Le point d'entrée du programme.
    public static void main( String [] args ) {
        
        // On produit un log de niveau informatif.
        LOGGER.log( Level.INFO, "Hello World with Log4J {}", 2 );

        try {
            int value = (int)( Math.random() * 2 );
            int result = 3 / value;
            LOGGER.info( "value == {} - result == {}", value, result );
        } catch( Exception exception ) {
            LOGGER.error( "Houston, we have a problem.", exception ); 
        }
        
    }

}
```

L'appel de la librairie log4j est associée à un fichier XML qui permet de configurer notamment :

* Le niveau à partir du quel les logs générés sont exportés ("info" dans l'exemple ci-dessous)
* Le format des loges (balise PatternLayout dans l'exemple ci-dessous (%m correspond au message et %n correspond à la fin de la ligne)
* La méthode d'écriture des logs en sortie du programme (balise \<console> dans l'exemple)
  * SYSTEM\_OUT = écriture dans la console lors de l'exécution du programme
  * Possible également d'écrire ces logs dans un fichier
  * Possible également d'envoyer les logs à un service distant

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<Configuration xmlns="http://logging.apache.org/log4j/2.0/config" status="WARN">

    <Appenders>
            
        <Console name="stdout" target="SYSTEM_OUT">
            <PatternLayout pattern="[%t] %-5p | %-60c | %m (%F:%L)%n" />
        </Console>
        
    </Appenders>

    <Loggers>
        
        <Root level="info">
            <AppenderRef ref="stdout" />
        </Root>
        
    </Loggers>

</Configuration>
```

## Lookups

Les lookups permettent d'ajouter des variables d'environnement dans les messages loggés.

Dans l'exemple ci-dessous on utilise le lookup `$${env:USER}` pour ajouter la variable d'environnement USER dans les logs.

```xml
<File name="Application" fileName="application.log">
  <PatternLayout>
    <pattern>%d %p %c{1.} [%t] $${env:USER} %m%n</pattern>
  </PatternLayout>
</File>
```

On pourrait également utilisé `$${env:USER: -jdoe}` pour logger jdoe par défaut quand la variable d'environnement USER n'est pas définie.

Il existe de nombreux types de lookups comme par exemple `${docker:containerName}` qui permet d'ajouter le nom du container dans un log.

## JNDI

La fonctionnalité JNDI remplit la même fonction que les lookups, à savoir ajouter des informations au caractère dynamique dans des messages loggés, mais JNDI est + puissante que les lookups :&#x20;

\+ puissant car JNDI permet de récupérer cette information auprès d'un service distant.

**Exemple de cas d'usage :**&#x20;

Différentes instances font tourner le même code java et il est nécessaire de récupérer une information dans une base mysql pour l'ajouter dans les logs (par exemple un nom d'utilisateur).

L'adresse IP interne associée à cette base mysql pourrait être amenée à varier.

Ainsi, plusieurs possibilités s'offrent au développeur pour assurer la maintenabilité de son code dans le temps :&#x20;

* Configurer une variable d'environnement sur chaque instance qui héberge le code Java avec l'adresse ip de la base (par exemple MYSQL\_IP=10.1.1.3)

\-> Cette solution requiert de s'assurer que la variable est bien synchronisée sur tous les systèmes&#x20;

* Renseigner cette information dans un composant centralisé et accessible par toutes les instances comme un annuaire

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
La fonctionnalité JNDI n'est pas propre à la librairie Log4J. Log4J permet d'utiliser une variable distante par le biais de la Feature JNDI mais
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>



## Histoire de la découverte

En 2016, des chercheurs en sécurité sont intervenus à la Black Hat pour présenter les vulnérabilités qui peuvent être associées à la fonctionnalité JNDI.&#x20;

Ils ont même préconisé le fait de ne pas utiliser d'entrée utilisateur non maîtrisée au sein des lookups

Il s'est écoulé 5 ans entre cette présentation et la révélation de la vulnérabilité. Cet écart est lié au fait que les professionnels de la sécurité ainsi que ls développeurs n'avaient pas été assez sensibilisé aux conséquences de la présentation de 2016.

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>
